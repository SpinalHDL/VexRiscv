notifications:
  email:
    on_success: never

env:
  - secure: "v7FHP8yK/zixpv1ML05qcRhZfDVDFdTmTPjfMZHL7gmrJveVDgze22x4tY4tB1+JEXhKuVTYvimOrX/Ok+rOOT5gVKLowv4PUQwCR+HgWVIbqjcfZNLsa369v03/p4K/zbjJSiXFahZYOXa0ApED2KWHcVfCrNsPv0UF7YZGiIa1Q/lPBwfmpN1rLih2Mpgn4KVaJky22t7JXJyVrNdGVmIA51slVbyFwFAE8Ww/0tkC+i2PUcWWRMIxtXP4iyq/9Npcq5VdqOatKfWHqAElLfKSPNMYLMlcyxyNpNx4paq8cL6fQxFcBLi9M2msz2i/qpKv30a0tzNo5bQQgucAXOQJB2Buks728upLuqsr+k25hwcqrtjyMOr9UQkt7qXAJH/0kimW7aW1yoMxbm/6mNG98X9D1EzNRewHAKatwJeFy1bw5qIuSQxPBwQMGloManrHOHGotmHKk7Y+dgM/z1UlaAdxSQuKWGXBc8QlQvif8puPYEdJMoInJNRxiWfYu06XnmzTXgMketK7RdULM9DVYzw8hzS2EIWKu8Oa0zn0PTevD2YeJNd4G8mDqO0vz5hloIc7pFsq/exQUB/kFozfCsnvhW8P+MPN0LpuSpptBQTsLWbM5BH0hd46HoWcneDdlMvVrUcgsTPmmSroIkLIEUo+Y2iN5eQHPPp85Cw="


_vexriscv: &_vexriscv
  language: scala
  # See 'project/Version.scala'
  scala:
    - 2.11.6

  sbt_args: -no-colors -J-Xss2m

  script:
    - export VEXRISCV_REGRESSION_CONFIG_COUNT=100
    - export VEXRISCV_REGRESSION_FREERTOS_COUNT=no
    - sbt -jvm-opts travis/jvmopts.compile compile
    - sbt -jvm-opts travis/jvmopts.test test

  jdk:
    - oraclejdk8
  #  - oraclejdk7
  #  - openjdk7

  before_install:
    # JDK fix
    - cat /etc/hosts # optionally check the content *before*
    - sudo hostname "$(hostname | cut -c1-63)"
    - sed -e "s/^\\(127\\.0\\.0\\.1.*\\)/\\1 $(hostname | cut -c1-63)/" /etc/hosts | sudo tee /etc/hosts
    - cat /etc/hosts # optionally check the content *after*
    - cd ..

    # Verilator
    - sudo apt-get install git make autoconf g++ flex bison -y  # First time prerequisites
    - git clone http://git.veripool.org/git/verilator   # Only first time
    - unset VERILATOR_ROOT  # For bash
    - cd verilator
    - git pull        # Make sure we're up-to-date
    - git checkout verilator_3_916
    - autoconf        # Create ./configure script
    - ./configure
    - make -j$(nproc)
    - sudo make install
    - cd ..

    - git clone https://github.com/SpinalHDL/SpinalHDL.git -b dev

    - cd VexRiscv
    #- curl -T README.md -udolu1990:$BINTRAY_KEY https://api.bintray.com/content/spinalhdl/VexRiscv/test/0.0.4/README.md
    #- curl -X POST -udolu1990:$BINTRAY_KEY https://api.bintray.com/content/spinalhdl/VexRiscv/test/0.0.4/publish
    #- sbt compile


  before_cache:
    # Tricks to avoid unnecessary cache updates
    - find $HOME/.ivy2 -name "ivydata-*.properties" -delete
    - find $HOME/.sbt -name "*.lock" -delete

  cache:
    directories:
      - $HOME/.ivy2/cache
      - $HOME/.sbt/boot/

_sphinx: &_sphinx
  language: python
  python:
    - 3.7
  dist: xenial
  sudo: true
  before_install:
    - cd docs
    - pip install pipenv
    - pipenv install

# jobs:
#   include:
#     - stage: test-links
#       script: pipenv run make linkcheck
#     - stage: build
#       script: pipenv run make html
#     - stage: deploy
#       script: pipenv run make html
#       deploy:
#         - provider: pages
#           skip-cleanup: true
#           github-token: $GITHUB_TOKEN  # Set in the settings page of your repository, as a secure variable
#           keep-history: true
#           local-dir: docs/html
#           on:
#             branch: master  # You can't be safe enough <insert double condom joke here>
#         - provider: releases
#           github-token: $GITHUB_TOKEN  # Set in the settings page of your repository, as a secure variable
#           file:
#           on:
#             tags: true




jobs:
  include:
    - stage: test-vexriscv
      <<: *_vexriscv
    - stage: test-links
      <<: *_sphinx
      script: pipenv run make linkcheck
    - stage: deploy
      <<: *_sphinx
      script: pipenv run make html
      deploy:
        - provider: pages
          skip-cleanup: true
          github-token: $GITHUB_TOKEN  # Set in the settings page of your repository, as a secure variable
          keep-history: false
          local-dir: docs/build/html
          on:
            branch: master  # You can't be safe enough <insert double condom joke here>

stages:
  - test-vexriscv
  - test-links
  - name: deploy
    if: branch = master  # Deploy only on master commits